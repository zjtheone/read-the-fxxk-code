Kernel pwn CTF å…¥é—¨ - 1

https://www.anquanke.com/post/id/255882


é˜…è¯»é‡
254553

|


å‘å¸ƒæ—¶é—´ : 2021-10-21 10:30:42



 

ä¸€ã€ç®€ä»‹
å†…æ ¸ CTF å…¥é—¨ï¼Œä¸»è¦å‚è€ƒ CTF-Wikiã€‚

 

äºŒã€ç¯å¢ƒé…ç½®
è°ƒè¯•å†…æ ¸éœ€è¦ä¸€ä¸ªä¼˜ç§€çš„ gdb æ’ä»¶ï¼Œè¿™é‡Œé€‰ç”¨ gefã€‚
æ ¹æ®å…¶ä»–å¸ˆå‚…æè¿°ï¼Œpeda å’Œ pwndbg åœ¨è°ƒè¯•å†…æ ¸æ—¶ä¼šæœ‰å¾ˆå¤šç„å­¦é—®é¢˜ã€‚

pip3 install capstone unicorn keystone-engine ropper
git clone https://github.com/hugsy/gef.git
echo source `pwd`/gef/gef.py >> ~/.gdbinit
å»æ¸…åæºä¸‹è½½ Linux kernel å‹ç¼©åŒ…å¹¶è§£å‹ï¼š
curl -O -L https://mirrors.tuna.tsinghua.edu.cn/kernel/v5.x/linux-5.9.8.tar.xz
unxz linux-5.9.8.tar.xz
tar -xf linux-5.9.8.tar
è¿›å…¥é¡¹ç›®æ–‡ä»¶å¤¹ï¼Œè¿›è¡Œ makefile é…ç½®
cd linux-5.9.8
make menuconfig
åœ¨å…¶ä¸­å‹¾é€‰

Kernel hacking -> Compile-time checks and compiler options -> Compile the kernel with debug info
Kernel hacking -> Generic Kernel Debugging Instruments -> KGDB: kernel debugger
ä¹‹åä¿å­˜é…ç½®å¹¶é€€å‡º

å¼€å§‹ç¼–è¯‘å†…æ ¸ï¼ˆé»˜è®¤ 32 ä½ï¼‰
make -j 8 bzImage
ä¸æ¨èç›´æ¥ make -j 8ï¼Œå› ä¸ºå®ƒä¼šç¼–è¯‘å¾ˆå¤šå¾ˆå¤šå¤§æ¦‚ç‡ç”¨ä¸ä¸Šçš„ä¸œè¥¿ã€‚

è¿™é‡Œæœ‰äº›å°å‘ï¼š

ç¼ºå¤±ä¾èµ–é¡¹ã€‚è§£å†³æ–¹æ³•ï¼šæ ¹æ® make çš„æŠ¥é”™ä¿¡æ¯æ¥å®‰è£…ä¾èµ–é¡¹ã€‚
sudo apt-get install libelf-dev
make[1]: *** No rule to make target 'debian/certs/debian-uefi-certs.pem', needed by 'certs/x509_certificate_list'. Stop.è§£å†³æ–¹æ³•ï¼šå°† .config ä¸­çš„ CONFIG_SYSTEM_TRUSTED_KEYS å†…å®¹ç½®ç©ºï¼Œç„¶åé‡æ–° makeã€‚
#
# Certificates for signature checking
#
CONFIG_SYSTEM_TRUSTED_KEYS="" # ç½®ç©º, ä¸è¦åˆ é™¤å½“å‰æ¡ç›®
ç­‰å‡ºç°äº†ä»¥ä¸‹ä¿¡æ¯ååˆ™ç¼–è¯‘å®Œæˆï¼š

Setup is 15420 bytes (padded to 15872 bytes).
System is 5520 kB
CRC 70701790
Kernel: arch/x86/boot/bzImage is ready  (#2)
æœ€ååœ¨å¯åŠ¨å†…æ ¸å‰ï¼Œå…ˆæ„å»ºä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿï¼Œå¦åˆ™å†…æ ¸ä¼šå› ä¸ºæ²¡æœ‰æ–‡ä»¶ç³»ç»Ÿè€ŒæŠ¥é”™ï¼š
Kernel panic - not syncing: VFS: Unable to mount root fs on unknown-block(0,0)
é¦–å…ˆä¸‹è½½ä¸€ä¸‹ busybox æºä»£ç ï¼š

wget https://busybox.net/downloads/busybox-1.34.1.tar.bz2
tar -jxf busybox-1.34.1.tar.bz2
ä¹‹åé…ç½® makefileï¼š

cd busybox-1.34.1
make menuconfig
make -j 8
åœ¨ menuconfig é¡µé¢ä¸­ï¼Œ

Setttings é€‰ä¸­ Build static binary (no shared libs), ä½¿å…¶ç¼–è¯‘æˆé™æ€é“¾æ¥çš„æ–‡ä»¶ï¼ˆå› ä¸º kernel ä¸æä¾› libc)éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œé™æ€ç¼–è¯‘ä¸é“¾æ¥éœ€è¦é¢å¤–å®‰è£…ä¸€ä¸ªä¾èµ–é¡¹ glibc-staticã€‚ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å®‰è£…ï¼š
# redhat/centosç³»åˆ—å®‰è£…:
sudo yum install glibc-static
# debian/ubuntuç³»åˆ—å®‰è£…
sudo apt-get install libc6-dev
åœ¨ Linux System Utilities ä¸­å–æ¶ˆé€‰ä¸­ Support mounting NFS file systems on Linux < 2.6.23 (NEW)
å½“å‰ç‰ˆæœ¬é»˜è®¤æ²¡æœ‰é€‰ä¸­è¯¥é¡¹ï¼Œå› æ­¤å¯ä»¥è·³è¿‡ã€‚

ç¼–è¯‘å®Œæˆåï¼Œä½¿ç”¨ make installå‘½ä»¤ï¼Œå°†ç”Ÿæˆæ–‡ä»¶å¤¹_installï¼Œè¯¥ç›®å½•å°†æˆä¸ºæˆ‘ä»¬çš„ rootfsã€‚

æ¥ä¸‹æ¥åœ¨ _install æ–‡ä»¶å¤¹ä¸‹æ‰§è¡Œä»¥åˆ›å»ºä¸€ç³»åˆ—æ–‡ä»¶ï¼š

mkdir -p  proc sys dev etc/init.d
ä¹‹åï¼Œåœ¨ rootfs ä¸‹ï¼ˆå³ _install æ–‡ä»¶å¤¹ä¸‹ï¼‰ç¼–å†™ä»¥ä¸‹ init æŒ‚è½½è„šæœ¬ï¼š

#!/bin/sh
echo "INIT SCRIPT"
mkdir /tmp
mount -t proc none /proc
mount -t sysfs none /sys
mount -t devtmpfs none /dev
mount -t debugfs none /sys/kernel/debug
mount -t tmpfs none /tmp
echo -e "Boot took $(cut -d' ' -f1 /proc/uptime) seconds"
setsid /bin/cttyhack setuidgid 1000 /bin/sh
æœ€åè®¾ç½® init è„šæœ¬çš„æƒé™ï¼Œå¹¶å°† rootfs æ‰“åŒ…ï¼š

chmod +x ./init
# æ‰“åŒ…å‘½ä»¤
find . | cpio -o --format=newc > ../../rootfs.img
# è§£åŒ…å‘½ä»¤
# cpio -idmv < rootfs.img
busyboxçš„ç¼–è¯‘ä¸å®‰è£…åœ¨æ„å»º rootfs ä¸­ä¸æ˜¯å¿…é¡»çš„ï¼Œä½†è¿˜æ˜¯å¼ºçƒˆå»ºè®®æ„å»º busyboxï¼Œå› ä¸ºå®ƒæä¾›äº†éå¸¸å¤šçš„æœ‰ç”¨å·¥å…·æ¥è¾…åŠ©ä½¿ç”¨ kernelã€‚

ä½¿ç”¨ qemu å¯åŠ¨å†…æ ¸ã€‚ä»¥ä¸‹æ˜¯ CTF wiki æ¨èçš„å¯åŠ¨å‚æ•°ï¼š
#!/bin/sh
qemu-system-x86_64 \
    -m 64M \
    -nographic \
    -kernel ./arch/x86/boot/bzImage \
    -initrd  ./rootfs.img \
    -append "root=/dev/ram rw console=ttyS0 oops=panic panic=1 nokaslr" \
    -smp cores=2,threads=1 \
    -cpu kvm64
æœ¬ç€å‡å°‘å‚æ•°è®¾ç½®çš„ç›®çš„ï¼Œè¿™æ˜¯ç¬”è€…çš„å¯åŠ¨å‚æ•°ï¼š

qemu-system-x86_64 \
  -kernel ./arch/x86/boot/bzImage \
  -initrd ./rootfs.img \
  -append "nokaslr"
å‡å°‘å¯åŠ¨çš„å‚æ•°ä¸ªæ•°ï¼Œå¯ä»¥è®©æˆ‘ä»¬åœ¨å…¥é—¨æ—¶ï¼Œæš‚æ—¶å±è”½æ‰ä¸€äº›ä¸å¿…è¦çš„ç»†èŠ‚ã€‚

è¿™é‡Œåªè®¾ç½®äº†ä¸‰ä¸ªå‚æ•°ï¼Œå…¶ä¸­ï¼š

-kernel æŒ‡å®šå†…æ ¸é•œåƒæ–‡ä»¶ bzImage è·¯å¾„
-initrd è®¾ç½®å†…æ ¸å¯åŠ¨çš„å†…å­˜æ–‡ä»¶ç³»ç»Ÿ
-append "nokaslr" å…³é—­ Kernel ALSR ä»¥ä¾¿äºè°ƒè¯•å†…æ ¸æ³¨æ„ï¼šnokaslr å¯ åƒä¸‡åƒä¸‡åƒä¸‡åˆ«æ‰“æˆ nokalsr äº†ã€‚å°±å› ä¸ºè¿™ä¸ªæˆ‘è°ƒè¯•äº†ä¸€ä¸ªä¸‹åˆçš„ kernelâ€¦â€¦æ˜¯çš„ CTF Wiki ä¸Šçš„ nokaslr ä¹Ÿæ˜¯é”™çš„ï¼Œå®ƒæ‰“æˆäº† nokalsr ï¼ˆxsï¼‰
å¯åŠ¨å¥½åå°±å¯ä»¥ä½¿ç”¨å†…ç½®çš„ shell äº†ã€‚

 

ä¸‰ã€å†…æ ¸é©±åŠ¨çš„ç¼–å†™ä¸è°ƒè¯•
1. æ„å»ºè¿‡ç¨‹
è¿™é‡Œæˆ‘ä»¬åœ¨ linux kernel é¡¹ç›®åŒ…ä¸‹æ–°å»ºäº†ä¸€ä¸ªæ–‡ä»¶å¤¹ï¼š

linux-5.9.8 $ mkdir mydrivers
ä¹‹ååœ¨è¯¥æ–‡ä»¶å¤¹ä¸‹æ”¾å…¥ä¸€ä¸ªé©±åŠ¨ä»£ç ko_test.cï¼Œä»£ç ç…§æ¬çš„ CTF-wikiï¼š

#include <linux/init.h>
#include <linux/module.h>
#include <linux/kernel.h>
MODULE_LICENSE("Dual BSD/GPL");
static int ko_test_init(void) 
{
    printk("This is a test ko!\n");
    return 0;
}
static void ko_test_exit(void) 
{
    printk("Bye Bye~\n");
}
module_init(ko_test_init);
module_exit(ko_test_exit);
ä»£ç ç¼–å†™å®Œæˆåï¼Œæ”¾å…¥ä¸€ä¸ª Makefileæ–‡ä»¶ï¼š

# æŒ‡å®šå£°ç§°å“ªäº› å†…æ ¸æ¨¡å—
obj-m += ko_test.o

# æŒ‡å®šå†…æ ¸é¡¹ç›®è·¯å¾„
KDIR =/usr/class/kernel_pwn/linux-5.9.8

all:
        # -C å‚æ•°æŒ‡å®šè¿›å…¥å†…æ ¸é¡¹ç›®è·¯å¾„
        # -M æŒ‡å®šé©±åŠ¨æºç çš„ç¯å¢ƒï¼Œä½¿ Makefile åœ¨æ„å»ºæ¨¡å—ä¹‹å‰è¿”å›åˆ° é©±åŠ¨æºç  ç›®å½•ï¼Œå¹¶åœ¨è¯¥ç›®å½•ä¸­ç”Ÿæˆé©±åŠ¨æ¨¡å—
        $(MAKE) -C $(KDIR) M=$(PWD) modules

clean:
        rm -rf *.o *.ko *.mod.* *.symvers *.order
æ³¨æ„ç‚¹ï¼š

Makefile æ–‡ä»¶åä¸­çš„é¦–å­—æ¯ M ä¸€å®šæ˜¯å¤§å†™ï¼Œå¦åˆ™ä¼šæŠ¥ä»¥ä¸‹é”™è¯¯ï¼š
scripts/Makefile.build:44: /usr/class/kernel_pwn/linux-5.9.8/mydrivers/Makefile: No such file or directory
make[2]: *** No rule to make target '/usr/class/kernel_pwn/linux-5.9.8/mydrivers/Makefile'.  Stop.
Makefile ä¸­ obj-m è¦ä¸åˆšåˆšçš„é©±åŠ¨ä»£ç æ–‡ä»¶åæ‰€å¯¹åº”ï¼Œå¦åˆ™ä¼šæŠ¥ä»¥ä¸‹é”™è¯¯ï¼š
make[2]: *** No rule to make target '/usr/class/kernel_pwn/linux-5.9.8/mydrivers/ko_test.o', needed by '/usr/class/kernel_pwn/linux-5.9.8/mydrivers/ko_test.mod'.  Stop.
å¦‚æœmakeæ—¶é‡åˆ°ä»¥ä¸‹é”™è¯¯ï¼š
makefile:6: *** missing separator.  Stop.
åˆ™ä½¿ç”¨ vim æ‰“å¼€ Makefileï¼Œé”®å…¥ i ä»¥è¿›å…¥è¾“å…¥æ¨¡å¼ï¼Œç„¶åæ›¿æ¢æ‰ make å‘½ä»¤å‰çš„å‰å¯¼ç©ºæ ¼ä¸º tabï¼Œæœ€åé”®å…¥ :wq ä¿å­˜ä¿®æ”¹ã€‚

æœ€åä½¿ç”¨ make å³å¯ç¼–è¯‘é©±åŠ¨ã€‚å®Œæˆåçš„ç›®å½•å†…å®¹å¦‚ä¸‹æ‰€ç¤ºï¼š

è¿™é‡Œæˆ‘ä»¬åªå…³æ³¨ ko_test.koã€‚

$ tree                  
.
â”œâ”€â”€ ko_test.c
â”œâ”€â”€ ko_test.ko
â”œâ”€â”€ ko_test.mod
â”œâ”€â”€ ko_test.mod.c
â”œâ”€â”€ ko_test.mod.o
â”œâ”€â”€ ko_test.o
â”œâ”€â”€ Makefile
â”œâ”€â”€ modules.order
â””â”€â”€ Module.symvers

0 directories, 9 files
2. è¿è¡Œè¿‡ç¨‹
å°†æ–°ç¼–è¯‘å‡ºæ¥çš„ *.ko æ–‡ä»¶å¤åˆ¶è¿› rootfs æ–‡ä»¶å¤¹ï¼ˆbusybox-1.34.1/_installï¼‰ä¸‹ï¼Œ

ä¹‹åä¿®æ”¹ busybox-1.34.1/_install/init è„šæœ¬ä¸­çš„å†…å®¹ï¼š

è¿™é‡Œéœ€è¦ææƒ /bin/shï¼Œ ç›®çš„æ˜¯ä¸ºäº†ä½¿ç”¨ root æƒé™å¯åŠ¨ /bin/shï¼Œä½¿å¾—æ‹¥æœ‰æ‰§è¡Œ dmesg å‘½ä»¤çš„æƒé™ã€‚

#!/bin/sh
echo "INIT SCRIPT"
mkdir /tmp
mount -t proc none /proc
mount -t sysfs none /sys
mount -t devtmpfs none /dev
mount -t debugfs none /sys/kernel/debug
mount -t tmpfs none /tmp
+ insmod /ko_test.ko # æŒ‚è½½å†…æ ¸æ¨¡å—
echo -e "Boot took $(cut -d' ' -f1 /proc/uptime) seconds"
- setsid /bin/cttyhack setuidgid 1000 /bin/sh
+ setsid /bin/cttyhack setuidgid 0 /bin/sh # ä¿®æ”¹ uid gid ä¸º 0 ä»¥ææƒ /bin/sh è‡³ rootã€‚
+ poweroff -f # è®¾ç½® shell é€€å‡ºååˆ™å…³é—­æœºå™¨
é‡æ–°æ‰“åŒ… rootfs å¹¶è¿è¡Œ qemuï¼Œä¹‹åé”®å…¥ dmesg å‘½ä»¤å³å¯çœ‹åˆ° ko_test æ¨¡å—å·²è¢«æˆåŠŸåŠ è½½ï¼š



æ­£å¸¸æƒ…å†µä¸‹ï¼Œæ‰§è¡Œ qemu ä¼šå¼¹å‡ºä¸€ä¸ªå°æ¡† GUIã€‚è‹¥æƒ³åƒä¸Šå›¾ä¸€æ ·å°†å¯åŠ¨çš„ç•Œé¢å˜æˆå½“å‰ç»ˆç«¯ï¼Œåˆ™éœ€åœ¨ qemu å¯åŠ¨æ—¶é¢å¤–æŒ‡å®šå‚æ•°ï¼š

-nographic
-append "console=ttyS0"
3. è°ƒè¯•è¿‡ç¨‹
a. attach qemu
è°ƒè¯•æ—¶æœ€å¥½ä½¿ç”¨ root æƒé™æ‰§è¡Œ /bin/shï¼Œç›¸å…³ä¿®æ”¹æ–¹æ³•å·²ç»åœ¨ä¸Šé¢è¯´æ˜ï¼Œæ­¤å¤„æš‚ä¸”ä¸è¡¨ã€‚

åœ¨å¯åŠ¨ qemu æ—¶ï¼Œé¢å¤–æŒ‡å®šå‚æ•° -gdb tcp::1234 ï¼ˆæˆ–è€…ç­‰ä»·çš„-sï¼‰ï¼Œä¹‹å qemu å°†åšå¥½ gdb attach çš„å‡†å¤‡ã€‚å¦‚æœå¸Œæœ› qemu å¯åŠ¨åç«‹å³æŒ‚èµ·ï¼Œåˆ™å¿…é¡»é™„å¸¦ -S å‚æ•°ã€‚

åŒæ—¶ï¼Œè°ƒè¯•å†…æ ¸æ—¶ï¼Œä¸ºäº†åŠ è½½ vmlinux ç¬¦å·è¡¨ï¼Œå¿…é¡»é¢å¤–æŒ‡å®š -append "nokaslr"ä»¥å…³é—­ kernel ASLRã€‚è¿™æ ·ç¬¦å·è¡¨æ‰èƒ½æ­£ç¡®çš„å¯¹åº”è‡³å†…å­˜ä¸­çš„æŒ‡å®šä½ç½®ï¼Œå¦åˆ™å°†æ— æ³•ç»™ç›®æ ‡å‡½æ•°ä¸‹æ–­ç‚¹ã€‚

qemuå¯åŠ¨åï¼Œå¿…é¡»å¦èµ·ä¸€ä¸ªç»ˆç«¯ï¼Œé”®å…¥ gdb -q -ex "target remote localhost:1234"ï¼Œå³å¯ attach è‡³ qemuä¸Šã€‚

gdb attach ä¸Š qemu åï¼Œå¯ä»¥åŠ è½½ vmlinux ç¬¦å·è¡¨ã€ç»™ç‰¹å®šå‡½æ•°ä¸‹æ–­ç‚¹ï¼Œå¹¶è¾“å…¥ continue ä»¥æ‰§è¡Œè‡³ç›®æ ‡å‡½æ•°å¤„ã€‚

# qemu æŒ‡å®š -S å‚æ•°åæŒ‚èµ·ï¼Œæ­¤æ—¶åœ¨gdbé”®å…¥ä»¥ä¸‹å‘½ä»¤
gef> add-symbol-file vmlinux
gef> b start_kernel
gef> continue

[Breakpoint 1, start_kernel () at init/main.c:837]
......
å¯¹äºå†…æ ¸ä¸­çš„å„ä¸ªç¬¦å·æ¥è¯´ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤æ¥æŸ¥çœ‹ä¸€äº›ç¬¦å·åœ¨å†…å­˜ä¸­çš„åŠ è½½åœ°å€ï¼š

# grep <symbol_name> /proc/kalsyms
grep prepare_kernel_cred  /proc/kallsyms
grep commit_creds  /proc/kallsyms
grep ko_test_init  /proc/kallsyms
å‘ç‚¹1ï¼šä¹‹å‰ç¬”è€…ç¼–å†™äº†ä»¥ä¸‹ shell è„šæœ¬ï¼š

# å…¶ä»–è®¾ç½®
[...]
# **åå°** å¯åŠ¨ qemu
qemu-system-x86_64 [other args] &
# ç›´æ¥åœ¨å½“å‰ç»ˆç«¯æ‰“å¼€ GDB
gdb -q -ex "target remote localhost:1234"
ä½†åœ¨æ‰§è¡Œè„šæœ¬æ—¶ï¼Œå½“ç¬”è€…åœ¨ GDB ä¸­é”®å…¥ Ctrl+C æ—¶ï¼Œ SIGINT ä¿¡å·å°†ç›´æ¥ç»ˆæ­¢ qemu è€Œä¸æ˜¯æŒ‚èµ·å†…éƒ¨çš„ kernelã€‚å› æ­¤ï¼Œgdbå¿…é¡»åœ¨å¦ä¸€ä¸ªç»ˆç«¯å¯åŠ¨æ‰å¯ä»¥æ­£å¸¸å¤„ç† Ctrl+Cã€‚

æ­£ç¡®çš„è„šæœ¬å¦‚ä¸‹ï¼š

# å…¶ä»–è®¾ç½®
[...]
# **åå°** å¯åŠ¨ qemu
qemu-system-x86_64 [other args] &
# å¼€å¯æ–°ç»ˆç«¯ï¼Œåœ¨æ–°ç»ˆç«¯ä¸­æ‰“å¼€ GDB
gnome-terminal -e 'gdb -q -ex "target remote localhost:1234"'
å‘ç‚¹2ï¼šå¯¹äº gdb gef æ’ä»¶æ¥è¯´ï¼Œæœ€å¥½ä¸è¦ä½¿ç”¨å¸¸è§„çš„target remote localhost:1234è¯­å¥ï¼ˆæ— éœ€rootæƒé™ï¼‰æ¥è¿æ¥è¿œç¨‹ï¼Œå¦åˆ™ä¼šæŠ¥ä»¥ä¸‹é”™è¯¯ï¼š

gefâ¤  target remote localhost:1234
Remote debugging using localhost:1234
warning: No executable has been specified and target does not support
determining executable automatically.  Try using the "file" command.
0x000000000000fff0 in ?? ()
[ Legend: Modified register | Code | Heap | Stack | String ]
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ registers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
[!] Command 'context' failed to execute properly, reason: 'NoneType' object has no attribute 'all_registers'
ä¸ä¹‹ç›¸å¯¹çš„ï¼Œä½¿ç”¨æ•ˆæœæ›´å¥½çš„ gef-remote å‘½ä»¤ï¼ˆéœ€è¦rootæƒé™ï¼‰è¿æ¥ qemuï¼š

# ä¸€å®šè¦æå‰æŒ‡å®šæ¶æ„
set architecture i386:x86-64
gef-remote --qemu-mode localhost:1234
å‘ç‚¹3ï¼šå¦‚æœ qemu æ–­åœ¨ start_kernelæ—¶ gef æŠ¥é”™ï¼š

[!] Command 'context' failed to execute properly, reason: max() arg is an empty sequence
ç›´æ¥å•æ­¥ ni ä¸€ä¸‹å³å¯ã€‚

b. attach drivers
1) å¸¸è§„æ­¥éª¤
é¦–å…ˆï¼Œ å°†ç›®æ ‡é©±åŠ¨åŠ è½½è¿›å†…æ ¸ä¸­ï¼š

insmod <driver_module_name>
ä¹‹åï¼Œé€šè¿‡ä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹ qemu ä¸­å†…æ ¸é©±åŠ¨çš„ text æ®µçš„è£…è½½åŸºåœ°å€ï¼š

# æŸ¥çœ‹è£…è½½é©±åŠ¨
lsmod
# è·å–é©±åŠ¨åŠ è½½çš„åŸºåœ°å€
grep <target_module_name> /proc/modules
åœ¨ gdb çª—å£ä¸­ï¼Œé”®å…¥ ä»¥ä¸‹å‘½ä»¤ä»¥åŠ è½½è°ƒè¯•ç¬¦å·ï¼š

add-symbol-file mydrivers/ko_test.ko <ko_test_base_addr> [-s <section1_name> <section1_addr>] ...
æ³¨ï¼Œä¸ vmlinux ä¸åŒï¼Œä½¿ç”¨ add-symbol-file åŠ è½½å†…æ ¸æ¨¡å—ç¬¦å·æ—¶ï¼Œå¿…é¡»æŒ‡å®šå†…æ ¸æ¨¡å—çš„ text æ®µåŸºåœ°å€ã€‚

å› ä¸ºå†…æ ¸ä½äºä¼—æ‰€å‘¨çŸ¥çš„è™šæ‹Ÿåœ°å€ï¼ˆè¯¥åœ°å€ä¸ vmlinux elf æ–‡ä»¶çš„åŠ è½½åœ°å€ç›¸åŒï¼‰ï¼Œä½†å†…æ ¸æ¨¡å—åªæ˜¯ä¸€ä¸ªå­˜æ¡£ï¼Œä¸å­˜åœ¨æœ‰æ•ˆåŠ è½½åœ°å€ï¼Œåªèƒ½ç­‰åˆ°å†…æ ¸åŠ è½½å™¨åˆ†é…å†…å­˜å¹¶å†³å®šåœ¨å“ªé‡ŒåŠ è½½æ­¤æ¨¡å—çš„æ¯ä¸ªå¯åŠ è½½éƒ¨åˆ†ã€‚å› æ­¤åœ¨åŠ è½½å†…æ ¸æ¨¡å—å‰ï¼Œæˆ‘ä»¬æ— æ³•å¾—çŸ¥å†…æ ¸æ¨¡å—å°†ä¼šåŠ è½½åˆ°å“ªå—å†…å­˜ä¸Šã€‚æ•…å°†ç¬¦å·æ–‡ä»¶åŠ è½½è¿› gdb æ—¶ï¼Œæˆ‘ä»¬å¿…é¡»å°½å¯èƒ½æ˜¾å¼æŒ‡å®šæ¯ä¸ª section çš„åœ°å€ã€‚

éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒåŠ è½½ç¬¦å·æ–‡ä»¶æ—¶ï¼Œè¶Šå¤šæŒ‡å®šæ¯ä¸ª section çš„åœ°å€è¶Šå¥½ã€‚å¦åˆ™å¦‚æœåªå•ç‹¬æŒ‡å®šäº† .text æ®µçš„åŸºåœ°å€ï¼Œåˆ™æœ‰å¯èƒ½åœ¨ç»™å‡½æ•°ä¸‹æ–­ç‚¹æ—¶æ–­ä¸ä¸‹æ¥ï¼Œéå¸¸å½±å“è°ƒè¯•ã€‚

å¦‚ä½•æŸ¥çœ‹ç›®æ ‡å†…æ ¸æ¨¡å—çš„å„ä¸ª section åŠ è½½é¦–åœ°å€å‘¢ï¼Ÿè¯·æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

grep "0x" /sys/module/ko_test/sections/.*
2) ä¾‹å­
ä¸€ä¸ªå°å°ä¾‹å­ï¼šè°ƒè¯• ko_test.ko çš„æ­¥éª¤å¦‚ä¸‹ï¼š

é¦–å…ˆåœ¨ qemu ä¸­çš„ kernel shell æ‰§è¡Œä»¥ä¸‹å‘½ä»¤
# é¦–å…ˆè£…è½½ ko_test è¿›å†…æ ¸ä¸­
insmod /ko_test.ko
# æŸ¥çœ‹å½“å‰ ko_test è£…è½½çš„åœ°å€
grep ko_test /proc/modules
grep "0x" /sys/module/ko_test/sections/.*
è¾“å‡ºå¦‚ä¸‹ï¼š



è®°å½•ä¸‹è¿™äº›åœ°å€ï¼Œä¹‹åè¿›å…¥ gdb ä¸­ï¼Œå…ˆæŒ‰ä¸‹ Ctrl+C æ–­ä¸‹ kernelï¼Œç„¶åé”®å…¥ä»¥ä¸‹å‘½ä»¤ï¼š
# å°†å¯¹åº”ç¬¦å·åŠ è½½è‡³è¯¥åœ°å€å¤„
add-symbol-file mydrivers/ko_test.ko  0xffffffffc0002000 \
                    -s .rodata.str1.1 0xffffffffc000304c \
                    -s .symtab        0xffffffffc0007000 \
                    -s .text.unlikely 0xffffffffc0002000
# ä¸‹æ–­ç‚¹
b ko_test_init
b ko_test_exit
# ä½¿å…¶ç»§ç»­æ‰§è¡Œ
continue


æœ€åå›åˆ° qemu ä¸­ï¼Œåœ¨ kernel shell ä¸­æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š
# å¸è½½ ko_test
rmmod ko_tes
æ­¤æ—¶ gdb ä¼šæ–­åˆ° ko_test_exit ä¸­ï¼š



å¦‚æœåœ¨å¸è½½äº†ko_teståï¼Œåˆé‡æ–°åŠ è½½ ko_testï¼Œ

insmod ko_test
åˆ™ gdb ä¼šç«‹å³æ–­åˆ° ko_test_init ä¸­ï¼š



è¿™å¯èƒ½æ˜¯å› ä¸ºæŒ‡å®šäº† nokaslrï¼Œä½¿å¾—ç›¸åŒé©±åŠ¨å¤šæ¬¡åŠ è½½çš„åŸºåœ°å€æ˜¯ä¸€è‡´çš„ã€‚

ä¸Šé¢è°ƒè¯• kernel module çš„ init å‡½æ•°æ–¹æ³•ç®—æ˜¯ä¸€ä¸ªå° trickï¼Œå®ƒåˆ©ç”¨äº† noaslr ç¯å¢ƒä¸‹ç›¸åŒé©±åŠ¨é‡æ–°åŠ è½½çš„åŸºåœ°å€ä¸€è‡´ çš„åŸç†æ¥ä¸‹æ–­ã€‚ä½†æœ€ä¸ºæ­£ç¡®çš„è°ƒè¯• init å‡½æ•°çš„æ–¹å¼ï¼Œè¿˜æ˜¯å¾—è·Ÿè¸ª do_init_module å‡½æ•°çš„æ§åˆ¶æµæ¥è·å–åŸºåœ°å€ã€‚ä»¥ä¸‹æ˜¯ä¸€ç³»åˆ—ç›¸å…³æ“ä½œæ­¥éª¤ï¼š

è·Ÿè¸ª do_init_module å‡½æ•°æ˜¯å› ä¸ºå®ƒåœ¨ load_module å‡½æ•°ä¸­è¢«è°ƒç”¨ã€‚load_moduleå‡½æ•°å°†åœ¨å®Œæˆå¤§é‡çš„å†…å­˜åŠ è½½å·¥ä½œåï¼Œæœ€åè¿›å…¥ do_init_module å‡½æ•°ä¸­æ‰§è¡Œå†…æ ¸æ¨¡å—çš„ init å‡½æ•°ï¼Œå¹¶åœ¨å…¶ä¸­è¿›è¡Œå–„åå·¥ä½œã€‚

load_moduleå‡½æ•°å°†è¢«ä½œä¸º SYSCALL å‡½æ•°çš„ init_moduleè°ƒç”¨ã€‚

é¦–å…ˆè®© kernel è·‘é£ï¼Œç­‰åˆ° kernel åŠ è½½å®Œæˆï¼Œshell ç•Œé¢æ˜¾ç¤ºåï¼Œgdb æŒ‰ä¸‹ ctrl + C æ–­ä¸‹ï¼Œç»™ do_init_moduleå‡½æ•°ä¸‹æ–­ã€‚è¯¥å‡½æ•°çš„å‰åŠéƒ¨åˆ†å°†ä¼šæ‰§è¡Œ å†…æ ¸æ¨¡å—çš„ init å‡½æ•°ï¼š
/*
 * This is where the real work happens.
 *
 * Keep it uninlined to provide a reliable breakpoint target, e.g. for the gdb
 * helper command 'lx-symbols'.
 */
static noinline int do_init_module(struct module *mod)
{
  [...]
  /* Start the module */
  if (mod->init != NULL)
    ret = do_one_initcall(mod->init);   // <- æ­¤å¤„æ‰§è¡Œ ko_test_init å‡½æ•°
  if (ret < 0) {
    goto fail_free_freeinit;
  }
  [...]
}
gdb é”®å…¥ continue å†è®© kernel è·‘é£ã€‚ä¹‹åkernel shell ä¸­è¾“å…¥ insmod /ko_test.koè£…è½½å†…æ ¸æ¨¡å—ï¼Œæ­¤æ—¶gdbä¼šæ–­ä¸‹ã€‚åœ¨ gdb ä¸­æŸ¥çœ‹ mod->init æˆå‘˜å³å¯æŸ¥çœ‹åˆ° kernel module init å‡½æ•°çš„é¦–åœ°å€ã€‚
è¦æƒ³çœ‹åˆ°å½“å‰ kernel module çš„å…¨éƒ¨ section åœ°å€ï¼Œå¯ä»¥åœ¨ gdb ä¸­é”®å…¥ä»¥ä¸‹å‘½ä»¤
# æŸ¥çœ‹å½“å‰ module çš„ sections ä¸ªæ•°
p mod->sect_attrs->nsections
# æŸ¥çœ‹ç¬¬ 3 ä¸ª section ä¿¡æ¯
p mod->sect_attrs->attrs[2]


æœ‰äº†å½“å‰å†…æ ¸æ¨¡å—çš„å…¨éƒ¨ section åç§°ä¸åŸºåœ°å€åï¼Œå°±å¯ä»¥æŒ‰ç…§ä¹‹å‰çš„æ–¹æ³•æ¥åŠ è½½ç¬¦å·æ–‡ä»¶äº†ã€‚

c. å¯åŠ¨è„šæœ¬
é…ç¯å¢ƒçœŸæ˜¯ä¸€ä»¶éº»çƒ¦åˆ°æç‚¹çš„äº‹æƒ…ï¼Œä¸è¿‡ç›®å‰å°±åˆ°æ­¤ä¸ºæ­¢äº† ğŸ™‚

ç¬”è€…å°†ä¸€ç³»åˆ—å¯åŠ¨å‘½ä»¤æ•´åˆæˆäº†ä¸€ä¸ª shell è„šæœ¬ï¼Œæ–¹ä¾¿ä¸€é”®è¿è¡Œï¼š

#! /bin/bash

# åˆ¤æ–­å½“å‰æƒé™æ˜¯å¦ä¸º rootï¼Œéœ€è¦é«˜æƒé™ä»¥æ‰§è¡Œ gef-remote --qemu-mode
user=$(env | grep "^USER" | cut -d "=" -f 2)
if [ "$user" != "root"  ]
  then
    echo "è¯·ä½¿ç”¨ root æƒé™æ‰§è¡Œ"
    exit
fi

# å¤åˆ¶é©±åŠ¨è‡³ rootfs
cp ./mydrivers/*.ko busybox-1.34.1/_install

# æ„å»º rootfs
pushd busybox-1.34.1/_install
find . | cpio -o --format=newc > ../../rootfs.img
popd

# å¯åŠ¨ qemu
qemu-system-x86_64 \
    -kernel ./arch/x86/boot/bzImage \
    -initrd ./rootfs.img \
    -append "nokaslr" \
    -s  \
    -S&

    # -s ï¼š ç­‰ä»·äº -gdb tcp::1234ï¼Œ æŒ‡å®š qemu çš„è°ƒè¯•é“¾æ¥
    # -S ï¼šæŒ‡å®š qemu å¯åŠ¨åç«‹å³æŒ‚èµ·

    # -nographic                # å…³é—­ QEMU å›¾å½¢ç•Œé¢
    # -append "console=ttyS0"   # å’Œ -nographic ä¸€èµ·ä½¿ç”¨ï¼Œå¯åŠ¨çš„ç•Œé¢å°±å˜æˆäº†å½“å‰ç»ˆç«¯

gnome-terminal -e 'gdb -x mygdbinit'
gdbinit å†…å®¹å¦‚ä¸‹ï¼š

set architecture i386:x86-64
add-symbol-file vmlinux
gef-remote --qemu-mode localhost:1234

b start_kernel
c
æœ¬æ–‡ç”±KipreyåŸåˆ›å‘å¸ƒ

è½¬è½½ï¼Œè¯·å‚è€ƒè½¬è½½å£°æ˜ï¼Œæ³¨æ˜å‡ºå¤„ï¼š https://www.anquanke.com/post/id/255882

å®‰å…¨å®¢ - æœ‰æ€æƒ³çš„å®‰å…¨æ–°åª’ä½“
